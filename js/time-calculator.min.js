 var timeStorage={};var numOfTimeEntries=7;$(document).ready(function(){if(checkBrowserSupported()===false){$("#browserSupportError").show();$("body").css("background-color","#FFF");}generateForm(numOfTimeEntries);loadPreviousEntriesFromStorage(numOfTimeEntries);$("#btnCalculateTotalTime").click(function(){calculateTotalTime(numOfTimeEntries);});$("#btnClear").click(function(){clearStorageAndForm(numOfTimeEntries);});$("#displayDate").datepicker({selectWeek:true,closeOnSelect:false,dateFormat:"D d M yy",altField:"#backendDate",altFormat:"yy-mm-dd-DD"});$("#displayDate").change(function(){var a=$("#backendDate").val();$("title").text(a+"-Timesheet");});$("#btnBackupData").click(function(){download();});$("#restoreFile").change(function(){$("#uploadProgress").show();$("#uploadForm").submit();});});function getContentsFromFileUpload(){var a=$("#uploadTarget").contents().find("#uploadedJsonData").html();timeStorage=JSON.parse(a);localStorage.setObject("timeStorage",timeStorage);loadPreviousEntriesFromStorage();$("#uploadProgress").hide();}function download(){calculateTotalTime();var b=$("#backendDate").val();var a=b+"-Timesheet.json";var c=JSON.stringify(timeStorage);$("#filename").val(a);$("#content").val(c);$("#downloadForm").submit();}function clearStorageAndForm(){localStorage.removeItem("timeStorage");for(var b=0;b<numOfTimeEntries;b++){$("#startHour"+b).val("").removeClass("timeError");$("#startMin"+b).val("").removeClass("timeError");$("#endHour"+b).val("").removeClass("timeError");$("#endMin"+b).val("").removeClass("timeError");$("#warningIcon"+b).hide();$("#task"+b).val("");$("#subTotal"+b).prop("checked",false);$("#totalTimeRow"+b).html(0);$("#totalTimeRowHoursMins"+b).html("");}$("#displayDate").val("");$("#backendDate").val("");$("#restoreFile").val("");$("#overallSubtotalTime").text(0);$("#overallSubtotalTimeHoursMins").text("");$("#overallTotalTime").html(0);$("#overallTotalTimeHoursMins").html("");var a=document.getElementById("backupData");a.src="";}function loadPreviousEntriesFromStorage(){timeStorage=localStorage.getObject("timeStorage");if(timeStorage!=null){for(var j=0;j<numOfTimeEntries;j++){var e=timeStorage[j].startHour;var f=timeStorage[j].startMin;var m=timeStorage[j].endHour;var n=timeStorage[j].endMin;var c=timeStorage[j].task;var l=timeStorage[j].subTotal;var o=timeStorage[j].totalTimeRow;var g=timeStorage[j].totalTimeRowHoursMins;c=c.replace(/&amp;/g,"&");$("#startHour"+j).val(e);$("#startMin"+j).val(f);$("#endHour"+j).val(m);$("#endMin"+j).val(n);$("#task"+j).val(c);if(l==true){$("#subTotal"+j).attr("checked","checked");}else{$("#subTotal"+j).removeAttr("checked");}if(o!=null){$("#totalTimeRow"+j).html(o);$("#totalTimeRowHoursMins"+j).html(g);}}var p=timeStorage.displayDate;var b=timeStorage.backendDate;$("#displayDate").val(p);$("#backendDate").val(b);$("title").text(b+" Timesheet");var h=timeStorage.overallTotalTime;var d=timeStorage.overallTotalTimeHoursMins;var k=timeStorage.overallSubtotalTime;var a=timeStorage.overallSubtotalTimeHoursMins;if(k!=null){$("#overallSubtotalTime").html(k);$("#overallSubtotalTimeHoursMins").html(a);}if(h!=null){$("#overallTotalTime").html(h);$("#overallTotalTimeHoursMins").html(d);}}else{timeStorage={};}}function calculateSubTotal(){var a=0;var g=0;for(var d=0;d<numOfTimeEntries;d++){var h=$("#subTotal"+d).is(":checked");if(h){var b=$("#startHour"+d).val();var c=$("#startMin"+d).val();var f=$("#endHour"+d).val();var j=$("#endMin"+d).val();var e=0;if((b!="")&&(c!="")&&(f!="")&&(j!="")){e=calculateTimeDifference(b,c,f,j);}a+=e;}}a=roundNumber(a,2);a=a;g=formatToHoursMins(a);$("#overallSubtotalTime").text(a);$("#overallSubtotalTimeHoursMins").text(g);timeStorage.overallSubtotalTime=a;timeStorage.overallSubtotalTimeHoursMins=g;}function calculateTimeDifference(h,g,d,f){var a=new Date("July 27, 2011 "+h+":"+g+":00");var e=new Date("July 27, 2011 "+d+":"+f+":00");var b=(e-a)/1000;var c=(b/60/60);return roundNumber(c,2);}function formatToHoursMins(e){e=Math.abs(e);var b=Math.floor(e);var f=e-Math.floor(e);var d=(f*60);d=Math.round(d);var c=(b>1)?" hours ":" hour ";var a=(d>1)?" mins":" min";e="";if(b!=0){e+=b+c;}if(d!=0){e+=d+a;}if((d==0)&&(b!=0)){e="";}return(e=="")?"":"("+e+")";}function calculateTotalTime(){var f=0;var c=0;for(var h=0;h<numOfTimeEntries;h++){var d=$("#startHour"+h).val();var e=$("#startMin"+h).val();var m=$("#endHour"+h).val();var n=$("#endMin"+h).val();var b=$("#task"+h).val();var j=$("#subTotal"+h).is(":checked");var l={rowKey:h,startHour:d,startMin:e,endHour:m,endMin:n,task:b,subTotal:j};if((d!="")&&(e!="")&&(m!="")&&(n!="")){var g=calculateTimeDifference(d,e,m,n);var k=formatToHoursMins(g);$("#totalTimeRow"+h).html(g);$("#totalTimeRowHoursMins"+h).html(k);l.totalTimeRow=g;l.totalTimeRowHoursMins=k;f=(f+g);}else{$("#totalTimeRow"+h).html(0);$("#totalTimeRowHoursMins"+h).html("");l.totalTimeRow=0;l.totalTimeRowHoursMins="";}timeStorage[h]=l;}var o=$("#displayDate").val();var a=$("#backendDate").val();timeStorage.displayDate=o;timeStorage.backendDate=a;calculateSubTotal(numOfTimeEntries);f=roundNumber(f,2);f=f;c=formatToHoursMins(f);$("#overallTotalTime").html(f);$("#overallTotalTimeHoursMins").html(c);timeStorage.overallTotalTime=f;timeStorage.overallTotalTimeHoursMins=c;localStorage.setObject("timeStorage",timeStorage);}function generateForm(){var h="";var f=13;var c=0;var b=15;var g=55;var e="Project XYZ. Fixed rendering bug.";var a=2;for(var d=0;d<numOfTimeEntries;d++){if(d!=0){f="";c="";b="";g="";e="";}h+='<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td class="rowHeading">Hour</td><td class="rowHeading">Min</td><td class="rowHeading">Task description</td><td class="rowHeading" style="width: 110px;">Subtotal</td><td class="rowHeading">Total</td></tr><tr><td rowspan="2"><img id="warningIcon'+d+'" class="hidden" src="img/warning-icon.png" title="Error on row: Either the start time is after the end time, the time fields are not completed or the time fields contain invalid characters"></td><td><a title="Use current time" href="#" onclick="getCurrentTimeInHoursMins(\'startHour'+d+"', 'startMin"+d+'\')"><img src="img/clock.png" alt="Current time"></a></td><td class="startEndTimeLegend">Start</td><td><input type="text" tabindex="'+a+'" onchange="validateField('+d+')" onkeyup="moveCursorOnMaxLength(\'startHour'+d+"', 'startMin"+d+'\')" id="startHour'+d+'" maxlength="2" placeholder="'+f+'" style="width:30px;"></td><td><input type="text" tabindex="'+(a+1)+'" onchange="validateField('+d+')" onkeyup="moveCursorOnMaxLength(\'startMin'+d+"', 'endHour"+d+'\')" id="startMin'+d+'" maxlength="2" placeholder="'+c+'" style="width:30px;"></td><td rowspan="2"><textarea tabindex="'+(a+4)+'" rows="2" id="task'+d+'" maxlength="200" placeholder="'+e+'" style="width:300px; height: 44px;"></textarea></td><td rowspan="2" class="alignCenter" style="width:90px;"><label for="subTotal'+d+'"><div class="checkboxLabel"><input type="checkbox" id="subTotal'+d+'"></div></label></td><td rowspan="2" class="alignCenter"><span id="totalTimeRow'+d+'">0</span> hours<br><span id="totalTimeRowHoursMins'+d+'" class="totalHoursMins"></span></td></tr><tr><td><a title="Use current time" href="#" onclick="getCurrentTimeInHoursMins(\'endHour'+d+"', 'endMin"+d+'\')"><img src="img/clock.png" alt="Current time"></a></td><td class="startEndTimeLegend">End</td><td><input type="text" tabindex="'+(a+2)+'" onchange="validateField('+d+')" onkeyup="moveCursorOnMaxLength(\'endHour'+d+"', 'endMin"+d+'\')" id="endHour'+d+'" maxlength="2" placeholder="'+b+'" style="width:30px;"></td><td><input type="text" tabindex="'+(a+3)+'" onchange="validateField('+d+')" onkeyup="moveCursorOnMaxLength(\'endMin'+d+"', 'task"+d+'\')" id="endMin'+d+'" maxlength="2" placeholder="'+g+'" style="width:30px;"></td></tr>';if(d!=(numOfTimeEntries-1)){h+='<tr><td colspan="8" style="line-height: 5px;">&nbsp;</td></tr>';}a+=5;}h+='<tr><td colspan="6">&nbsp;</td><td class="totalLegend">Subtotal</td><td class="totalLegend">Overall Total</td></tr><tr><td colspan="6">&nbsp;</td><td style="text-align: center;"><span id="overallSubtotalTime">0</span> hours<br><span id="overallSubtotalTimeHoursMins" class="totalHoursMins"></span></td><td style="text-align: center;"><span id="overallTotalTime">0</span> hours<br><span id="overallTotalTimeHoursMins" class="totalHoursMins"></span></td></tr>';$("#timeRows").html(h);}function getCurrentTimeInHoursMins(e,b){var a=new Date();var d=padNumber(a.getHours());var c=padNumber(a.getMinutes());$("#"+e).val(d);$("#"+b).val(c);}function validateField(e){var d=$("#startHour"+e);var c=$("#startMin"+e);var a=$("#endHour"+e);var b=$("#endMin"+e);checkHourInRange(d);checkMinuteInRange(c);checkHourInRange(a);checkMinuteInRange(b);checkTimeDifference(d,c,a,b,e);}function checkHourInRange(b){var a=b.val();if((a>=0)&&(a<=24)){b.removeClass("timeError");}else{b.addClass("timeError");}}function checkMinuteInRange(b){var a=b.val();if((a>=0)&&(a<=59)){b.removeClass("timeError");}else{b.addClass("timeError");}}function checkTimeDifference(f,d,b,c,e){var a=calculateTimeDifference(f.val(),d.val(),b.val(),c.val());if((isNaN(a))||(a<=0)){if((f.val()=="")&&(d.val()=="")&&(b.val()=="")&&(c.val()=="")){$("#warningIcon"+e).hide();}else{$("#warningIcon"+e).show();}}else{$("#warningIcon"+e).hide();}}function moveCursorOnMaxLength(b,c){var f=$("#"+b);var e=f.val();var d=$("#"+c);if(e.length>=f.attr("maxlength")){d.focus();}else{if(b.indexOf("Hour")!=-1){var a=[3,4,5,6,7,8,9];e=parseInt(e);if($.inArray(e,a)!==-1){e=padNumber(e);f.val(e);d.focus();}}}}function roundNumber(b,a){var c=new Number(b+"").toFixed(parseInt(a));return parseFloat(c);}function padNumber(a){return(a<10?"0":"")+a;}function stringToBoolean(a){switch(a){case"true":case"yes":case"1":return true;case"false":case"no":case"0":case null:return false;default:return Boolean(a);}}function utf8_to_b64(a){return window.btoa(unescape(encodeURIComponent(a)));}function b64_to_utf8(a){return decodeURIComponent(escape(window.atob(a)));}function checkSupportForHtml5Storage(){try{return"localStorage" in window&&window.localStorage!==null;}catch(a){return false;}}function checkBrowserSupported(){var b=navigator.userAgent.toLowerCase();var a={version:(b.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],webkit:/webkit/.test(b),opera:/opera/.test(b),msie:/msie/.test(b)&&!/opera/.test(b),mozilla:/mozilla/.test(b)&&!/(compatible|webkit)/.test(b)};if((a.webkit===true)||(a.opera===true)||(a.mozilla===true)){if(checkSupportForHtml5Storage()===false){$("#browserSupportError").html("HTML5 local storage support is not available");return false;}else{return true;}}else{if((a.msie===true)&&(a.version>8)){return true;}else{return false;}}}Storage.prototype.setObject=function(a,b){this.setItem(a,JSON.stringify(b));};Storage.prototype.getObject=function(a){var b=this.getItem(a);if(b=="undefined"){return null;}else{return b&&JSON.parse(b);}}; 