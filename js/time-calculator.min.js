/**
 * Time Calculator Javascript
 * Copyright Â© 2011 Chris Riley
 * 
 * Source code released under the MIT licence.
 * http://www.opensource.org/licenses/mit-license.php
 */
function setupGoogleAnalytics(){var a=a||[];a.push(["_setAccount","UA-27217678-1"]);a.push(["_trackPageview"]);(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)})()}function checkBrowserSupported(){var a=navigator.userAgent.toLowerCase();var b={version:(a.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],webkit:/webkit/.test(a),opera:/opera/.test(a),msie:/msie/.test(a)&&!/opera/.test(a),mozilla:/mozilla/.test(a)&&!/(compatible|webkit)/.test(a)};if(b.webkit===true||b.opera===true||b.mozilla===true){if(checkSupportForHtml5Storage()===false){$("#browserSupportError").html("HTML5 local storage support is not available");return false}else{return true}}else if(b.msie===true&&b.version>8){return true}else{return false}}function checkSupportForHtml5Storage(){try{return"localStorage"in window&&window["localStorage"]!==null}catch(a){return false}}function b64_to_utf8(a){return decodeURIComponent(escape(window.atob(a)))}function utf8_to_b64(a){return window.btoa(unescape(encodeURIComponent(a)))}function stringToBoolean(a){switch(a){case"true":case"yes":case"1":return true;case"false":case"no":case"0":case null:return false;default:return Boolean(a)}}function padNumber(a){return(a<10?"0":"")+a}function roundNumber(a,b){var c=(new Number(a+"")).toFixed(parseInt(b));return parseFloat(c)}function moveCursorOnMaxLength(a,b){var c=$("#"+a);var d=c.val();var e=$("#"+b);if(d.length>=c.attr("maxlength")){e.focus()}else{if(a.indexOf("Hour")!=-1){var f=[3,4,5,6,7,8,9];d=parseInt(d);if($.inArray(d,f)!==-1){d=padNumber(d);c.val(d);e.focus()}}}}function checkTimeDifference(a,b,c,d,e){var f=calculateTimeDifference(a.val(),b.val(),c.val(),d.val());if(isNaN(f)||f<=0){if(a.val()==""&&b.val()==""&&c.val()==""&&d.val()==""){$("#warningIcon"+e).hide()}else{$("#warningIcon"+e).show()}}else{$("#warningIcon"+e).hide()}}function checkMinuteInRange(a){var b=a.val();if(b>=0&&b<=59){a.removeClass("timeError")}else{a.addClass("timeError")}}function checkHourInRange(a){var b=a.val();if(b>=0&&b<=24){a.removeClass("timeError")}else{a.addClass("timeError")}}function validateField(a){var b=$("#startHour"+a);var c=$("#startMin"+a);var d=$("#endHour"+a);var e=$("#endMin"+a);checkHourInRange(b);checkMinuteInRange(c);checkHourInRange(d);checkMinuteInRange(e);checkTimeDifference(b,c,d,e,a)}function getCurrentTimeInHoursMins(a,b){var c=new Date;var d=padNumber(c.getHours());var e=padNumber(c.getMinutes());$("#"+a).val(d);$("#"+b).val(e)}function generateForm(){var a="";var b=13;var c=0;var d=15;var e=55;var f="Project XYZ. Fixed rendering bug.";var g=2;for(var h=0;h<numOfTimeEntries;h++){if(h!=0){b="";c="";d="";e="";f=""}a+="<tr>"+"<td> </td>"+"<td> </td>"+"<td> </td>"+'<td class="rowHeading">Hour</td>'+'<td class="rowHeading">Min</td>'+'<td class="rowHeading">Task description</td>'+'<td class="rowHeading" style="width: 110px;">Subtotal</td>'+'<td class="rowHeading">Total</td>'+"</tr>"+"<tr>"+'<td rowspan="2"><img id="warningIcon'+h+'" class="hidden" src="img/warning-icon.png" title="Error on row: Either the start time is after the end time, the time fields are not completed or the time fields contain invalid characters"></td>'+"<td>"+'<a title="Use current time" href="#" onclick="getCurrentTimeInHoursMins(\'startHour'+h+"', 'startMin"+h+"')\">"+'<img src="img/clock.png" alt="Current time">'+"</a>"+"</td>"+'<td class="startEndTimeLegend">Start</td>'+'<td><input type="text" tabindex="'+g+'" onchange="validateField('+h+')" onkeyup="moveCursorOnMaxLength(\'startHour'+h+"', 'startMin"+h+'\')" id="startHour'+h+'" maxlength="2" placeholder="'+b+'" style="width:30px;"></td>'+'<td><input type="text" tabindex="'+(g+1)+'" onchange="validateField('+h+')" onkeyup="moveCursorOnMaxLength(\'startMin'+h+"', 'endHour"+h+'\')" id="startMin'+h+'" maxlength="2" placeholder="'+c+'" style="width:30px;"></td>'+'<td rowspan="2"><textarea tabindex="'+(g+4)+'" rows="2" id="task'+h+'" maxlength="200" placeholder="'+f+'" style="width:300px; height: 44px;"></textarea></td>'+'<td rowspan="2" class="alignCenter" style="width:90px;">'+'<label for="subTotal'+h+'">'+'<div class="checkboxLabel">'+'<input type="checkbox" id="subTotal'+h+'">'+"</div>"+"</label>"+"</td>"+'<td rowspan="2" class="alignCenter">'+'<span id="totalTimeRow'+h+'">0</span> hours<br>'+'<span id="totalTimeRowHoursMins'+h+'" class="totalHoursMins"></span>'+"</td>"+"</tr>"+"<tr>"+"<td>"+'<a title="Use current time" href="#" onclick="getCurrentTimeInHoursMins(\'endHour'+h+"', 'endMin"+h+"')\">"+'<img src="img/clock.png" alt="Current time">'+"</a>"+"</td>"+'<td class="startEndTimeLegend">End</td>'+'<td><input type="text" tabindex="'+(g+2)+'" onchange="validateField('+h+')" onkeyup="moveCursorOnMaxLength(\'endHour'+h+"', 'endMin"+h+'\')" id="endHour'+h+'" maxlength="2" placeholder="'+d+'" style="width:30px;"></td>'+'<td><input type="text" tabindex="'+(g+3)+'" onchange="validateField('+h+')" onkeyup="moveCursorOnMaxLength(\'endMin'+h+"', 'task"+h+'\')" id="endMin'+h+'" maxlength="2" placeholder="'+e+'" style="width:30px;"></td>'+"</tr>";if(h!=numOfTimeEntries-1){a+='<tr><td colspan="8" style="line-height: 5px;"> </td></tr>'}g+=5}a+="<tr>"+'<td colspan="6"> </td>'+'<td class="totalLegend">Subtotal</td>'+'<td class="totalLegend">Overall Total</td>'+"</tr>"+"<tr>"+'<td colspan="6"> </td>'+'<td style="text-align: center;">'+'<span id="overallSubtotalTime">0</span> hours<br>'+'<span id="overallSubtotalTimeHoursMins" class="totalHoursMins"></span>'+"</td>"+'<td style="text-align: center;">'+'<span id="overallTotalTime">0</span> hours<br>'+'<span id="overallTotalTimeHoursMins" class="totalHoursMins"></span>'+"</td>"+"</tr>";$("#timeRows").html(a)}function calculateTotalTime(){var a=0;var b=0;for(var c=0;c<numOfTimeEntries;c++){var d=$("#startHour"+c).val();var e=$("#startMin"+c).val();var f=$("#endHour"+c).val();var g=$("#endMin"+c).val();var h=$("#task"+c).val();var i=$("#subTotal"+c).is(":checked");var j={rowKey:c,startHour:d,startMin:e,endHour:f,endMin:g,task:h,subTotal:i};if(d!=""&&e!=""&&f!=""&&g!=""){var k=calculateTimeDifference(d,e,f,g);var l=formatToHoursMins(k);$("#totalTimeRow"+c).html(k);$("#totalTimeRowHoursMins"+c).html(l);j["totalTimeRow"]=k;j["totalTimeRowHoursMins"]=l;a=a+k}else{$("#totalTimeRow"+c).html(0);$("#totalTimeRowHoursMins"+c).html("");j["totalTimeRow"]=0;j["totalTimeRowHoursMins"]=""}timeStorage[c]=j}var m=$("#displayDate").val();var n=$("#backendDate").val();timeStorage["displayDate"]=m;timeStorage["backendDate"]=n;calculateSubTotal(numOfTimeEntries);a=roundNumber(a,2);a=a;b=formatToHoursMins(a);$("#overallTotalTime").html(a);$("#overallTotalTimeHoursMins").html(b);timeStorage["overallTotalTime"]=a;timeStorage["overallTotalTimeHoursMins"]=b;localStorage.setObject("timeStorage",timeStorage)}function formatToHoursMins(a){a=Math.abs(a);var b=Math.floor(a);var c=a-Math.floor(a);var d=c*60;d=Math.round(d);var e=b>1?" hours ":" hour ";var f=d>1?" mins":" min";a="";if(b!=0){a+=b+e}if(d!=0){a+=d+f}if(d==0&&b!=0){a=""}return a==""?"":"("+a+")"}function calculateTimeDifference(a,b,c,d){var e=new Date("July 27, 2011 "+a+":"+b+":"+"00");var f=new Date("July 27, 2011 "+c+":"+d+":"+"00");var g=(f-e)/1e3;var h=g/60/60;return roundNumber(h,2)}function calculateSubTotal(){var a=0;var b=0;for(var c=0;c<numOfTimeEntries;c++){var d=$("#subTotal"+c).is(":checked");if(d){var e=$("#startHour"+c).val();var f=$("#startMin"+c).val();var g=$("#endHour"+c).val();var h=$("#endMin"+c).val();var i=0;if(e!=""&&f!=""&&g!=""&&h!=""){i=calculateTimeDifference(e,f,g,h)}a+=i}}a=roundNumber(a,2);a=a;b=formatToHoursMins(a);$("#overallSubtotalTime").text(a);$("#overallSubtotalTimeHoursMins").text(b);timeStorage["overallSubtotalTime"]=a;timeStorage["overallSubtotalTimeHoursMins"]=b}function loadPreviousEntriesFromStorage(){timeStorage=localStorage.getObject("timeStorage");if(timeStorage!=null){for(var a=0;a<numOfTimeEntries;a++){var b=timeStorage[a].startHour;var c=timeStorage[a].startMin;var d=timeStorage[a].endHour;var e=timeStorage[a].endMin;var f=timeStorage[a].task;var g=timeStorage[a].subTotal;var h=timeStorage[a].totalTimeRow;var i=timeStorage[a].totalTimeRowHoursMins;f=f.replace(/&/g,"&");$("#startHour"+a).val(b);$("#startMin"+a).val(c);$("#endHour"+a).val(d);$("#endMin"+a).val(e);$("#task"+a).val(f);if(g==true){$("#subTotal"+a).attr("checked","checked")}else{$("#subTotal"+a).removeAttr("checked")}if(h!=null){$("#totalTimeRow"+a).html(h);$("#totalTimeRowHoursMins"+a).html(i)}}var j=timeStorage["displayDate"];var k=timeStorage["backendDate"];$("#displayDate").val(j);$("#backendDate").val(k);$("title").text(k+" Timesheet");var l=timeStorage["overallTotalTime"];var m=timeStorage["overallTotalTimeHoursMins"];var n=timeStorage["overallSubtotalTime"];var o=timeStorage["overallSubtotalTimeHoursMins"];if(n!=null){$("#overallSubtotalTime").html(n);$("#overallSubtotalTimeHoursMins").html(o)}if(l!=null){$("#overallTotalTime").html(l);$("#overallTotalTimeHoursMins").html(m)}}else{timeStorage={}}}function clearStorageAndForm(){localStorage.removeItem("timeStorage");for(var a=0;a<numOfTimeEntries;a++){$("#startHour"+a).val("").removeClass("timeError");$("#startMin"+a).val("").removeClass("timeError");$("#endHour"+a).val("").removeClass("timeError");$("#endMin"+a).val("").removeClass("timeError");$("#warningIcon"+a).hide();$("#task"+a).val("");$("#subTotal"+a).prop("checked",false);$("#totalTimeRow"+a).html(0);$("#totalTimeRowHoursMins"+a).html("")}$("#displayDate").val("");$("#backendDate").val("");$("#restoreFile").val("");$("#overallSubtotalTime").text(0);$("#overallSubtotalTimeHoursMins").text("");$("#overallTotalTime").html(0);$("#overallTotalTimeHoursMins").html("");var b=document.getElementById("backupData");b.src=""}function download(){calculateTotalTime();var a=$("#backendDate").val();var b=a+"-Timesheet.json";var c=JSON.stringify(timeStorage);$("#filename").val(b);$("#content").val(c);$("#downloadForm").submit()}function getContentsFromFileUpload(){var a=$("#uploadTarget").contents().find("#uploadedJsonData").html();timeStorage=JSON.parse(a);localStorage.setObject("timeStorage",timeStorage);loadPreviousEntriesFromStorage();$("#uploadProgress").hide()}var timeStorage={};var numOfTimeEntries=7;$(document).ready(function(){setupGoogleAnalytics();if(checkBrowserSupported()===false){$("#browserSupportError").show();$("body").css("background-color","#FFF")}generateForm(numOfTimeEntries);loadPreviousEntriesFromStorage(numOfTimeEntries);$("#btnCalculateTotalTime").click(function(){calculateTotalTime(numOfTimeEntries)});$("#btnClear").click(function(){clearStorageAndForm(numOfTimeEntries)});$("#displayDate").datepicker({selectWeek:true,closeOnSelect:false,dateFormat:"D d M yy",altField:"#backendDate",altFormat:"yy-mm-dd-DD"});$("#displayDate").change(function(){var a=$("#backendDate").val();$("title").text(a+"-Timesheet")});$("#btnBackupData").click(function(){download()});$("#restoreFile").change(function(){$("#uploadProgress").show();$("#uploadForm").submit()})});Storage.prototype.setObject=function(a,b){this.setItem(a,JSON.stringify(b))};Storage.prototype.getObject=function(a){var b=this.getItem(a);if(b=="undefined"){return null}else{return b&&JSON.parse(b)}}